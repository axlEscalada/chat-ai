name: CI
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
jobs:
  run_autonoma_tests:
    runs-on: ubuntu-latest
    name: Run Autonoma Tests
    steps:
      - name: Run Folder Tests (cmbi84wla0178xv01zzf8o79n)
        id: step-1
        uses: autonoma-ai/actions/folder-runner@v1
        with:
          folder-id: "cmbi84wla0178xv01zzf8o79n"
          client-id: ${{ secrets.AUTONOMA_CLIENT_ID }}
          client-secret: ${{ secrets.AUTONOMA_CLIENT_SECRET }}
          max-wait-time: "10"
      - name: Show test results
        if: always()
        run: |
          echo "Test status: ${{ steps.step-1.outputs.final-status }}"
          echo "Message: ${{ steps.step-1.outputs.message }}"
          echo "View results at: ${{ steps.step-1.outputs.url }}"
          echo "Run ID: ${{ steps.step-1.outputs.run-id }}"
      # Debug API connectivity (keeping your original curl)
      - name: Immediate API Test
        if: always()
        run: |
          echo "Testing API immediately after run creation..."
          echo "Run ID: ${{ steps.step-1.outputs.run-id }}"

          # Test 1: Immediate request
          echo "=== Immediate Test ==="
          curl -v -s -w "%{http_code}" \
            -H "autonoma-client-id: ${{ secrets.AUTONOMA_CLIENT_ID }}" \
            -H "autonoma-client-secret: ${{ secrets.AUTONOMA_CLIENT_SECRET }}" \
            -H "Content-Type: application/json" \
            -H "User-Agent: GitHub-Actions-Test" \
            "https://latest.prod.autonoma.app/api/run/folder/${{ steps.step-1.outputs.run-id }}" \
            -o immediate_response.json

          if [ -f immediate_response.json ]; then
            echo "Immediate response:"
            cat immediate_response.json
          fi

          # Test 2: After 10 second delay
          echo "=== After 10 second delay ==="
          sleep 10
          curl -v -s -w "%{http_code}" \
            -H "autonoma-client-id: ${{ secrets.AUTONOMA_CLIENT_ID }}" \
            -H "autonoma-client-secret: ${{ secrets.AUTONOMA_CLIENT_SECRET }}" \
            -H "Content-Type: application/json" \
            -H "User-Agent: GitHub-Actions-Test" \
            "https://latest.prod.autonoma.app/api/run/folder/${{ steps.step-1.outputs.run-id }}" \
            -o delayed_response.json

          if [ -f delayed_response.json ]; then
            echo "Delayed response:"
            cat delayed_response.json
          FI

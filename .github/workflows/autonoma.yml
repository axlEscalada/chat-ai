name: CI
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
jobs:
  run_autonoma_tests:
    runs-on: ubuntu-latest
    name: Run Autonoma Tests
    steps:
      - name: Run Folder Tests (cmbi84wla0178xv01zzf8o79n)
        id: step-1
        uses: autonoma-ai/actions/folder-runner@v1
        with:
          folder-id: "cmbi84wla0178xv01zzf8o79n"
          client-id: ${{ secrets.AUTONOMA_CLIENT_ID }}
          client-secret: ${{ secrets.AUTONOMA_CLIENT_SECRET }}
          max-wait-time: "10"
      - name: Show test results
        if: always()
        run: |
          echo "Test status: ${{ steps.step-1.outputs.final-status }}"
          echo "Message: ${{ steps.step-1.outputs.message }}"
          echo "View results at: ${{ steps.step-1.outputs.url }}"
          echo "Run ID: ${{ steps.step-1.outputs.run-id }}"
      # Debug API connectivity (keeping your original curl)
      - name: Debug API connectivity
        if: failure()
        run: |
          echo "Debugging API connectivity..."
          echo "Testing with actual failed run ID: ${{ steps.step-1.outputs.run-id }}"
          # Test the failing URL
          response1=$(curl -s -w "%{http_code}" \
            -H "autonoma-client-id: ${{ secrets.AUTONOMA_CLIENT_ID }}" \
            -H "autonoma-client-secret: ${{ secrets.AUTONOMA_CLIENT_SECRET }}" \
            -H "Content-Type: application/json" \
            --connect-timeout 60 \
            --max-time 60 \
            "https://latest.prod.autonoma.app/api/run/folder/${{ steps.step-1.outputs.run-id }}" \
            -o response1.json)

          echo "Response 1 HTTP code: ${response1: -3}"
          if [ -f response1.json ]; then
            echo "Response 1 body:"
            cat response1.json
          fi

          # Also test without the subdomain path
          response2=$(curl -s -w "%{http_code}" \
            -H "autonoma-client-id: ${{ secrets.AUTONOMA_CLIENT_ID }}" \
            -H "autonoma-client-secret: ${{ secrets.AUTONOMA_CLIENT_SECRET }}" \
            -H "Content-Type: application/json" \
            --connect-timeout 60 \
            --max-time 60 \
            "https://latest.prod.autonoma.app/api/run/${{ steps.step-1.outputs.run-id }}" \
            -o response2.json)

          echo "Response 2 HTTP code: ${response2: -3}"
          if [ -f response2.json ]; then
            echo "Response 2 body:"
            cat response2.json
          fi
